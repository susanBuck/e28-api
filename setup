# Update the following variables as needed if you're not using DigitalOcean
productionDocRoot="/var/www/html/e28/e28-api"
productionUser='www-data'



#
# Output
#
function dump {
    echo ""
    echo "===> $1"
} 



#
# Detect system
#
dump "Detecting system"

curDir=$(pwd)
publicDir=$curDir/public/

if [ -d $productionDocRoot ]; then
    server="production"
    phpExecutable="/usr/bin/php"
else
    server="local"
    # Windows
    if [ -d "c:\xampp\php" ]; then
        phpExecutable="c:\xampp\php\php.exe"
        # Replace the staring "/c/" with "c:/"
        curDir=${curDir/\/c\//c:\/}
        # Replace all forward slashes with backwards slashes
        curDir=${curDir//\//\\}
        publicDir="$curDir\\public\\"
    # Mac
    elif [ -d "/Applications/XAMPP/xamppfiles/bin" ]; then
        phpExecutable="/Applications/XAMPP/xamppfiles/bin/php"
    # Other
    else 
        phpExecutable="php"
    fi
fi

echo "Server: $server"
echo "PHP Executable: $phpExecutable"
echo "Current working directory: $curDir"
echo "Public directory: $publicDir"



#
# Update core
#
dump "Updating e28-api-core"

# Make core directory if it doesn't exist
mkdir -p core

# All other commands should be run in core/
cd core

# Update e28-api-core if it already exists (`app` directory present)
if [ -d "app" ]; then
    git pull
# Clone e28-api-core if it does not yet exist
else
    git clone git@github.com:susanBuck/e28-api-core.git .
fi


#
# Packages
#
if [ $server == 'production' ]; then

    # If we have sqlite3, we can assume server prep has already been completed - skip
    if php -m | grep sqlite3 >/dev/null; then
        dump "Server already prepped to run Laravel application"
    else
        dump "Prepping server to run Laravel application"

        echo "Adding modules"
        sudo add-apt-repository ppa:ondrej/php
        sudo apt-get update
        sudo apt-get install php7.4-mbstring zip unzip php7.4-xml php-sqlite3

        echo "Enabling modrewrite"
        # Laravel requires Apache's `mod_rewrite` for URL routing, so we enable it:
        sudo a2enmod rewrite

        echo "Restarting Apache"
        service apache2 restart
    fi
fi


#
# Database
#
dump "Setting up database"
touch database/database.sqlite
if [ $server == 'production' ]; then
    # the PDO SQLite driver requires that if you are going to do a write operation (INSERT, UPDATE, DELETE, DROP, etc.),
    # then the folder the database resides in must have write permissions, as well as the actual database file
    chown -R ${user} "${apiRoot}/core/database"
fi

# Do initial migration (so sessions and other fundamental tables exist, allowing artisan scripts to run w/o error)
$phpExecutable artisan migrate --force

#
# Laravel initial setup
#
if [ ! -f ".env" ]; then
    dump "Laravel initial setup"

    echo "Creating environment file (.env)"
    cp .env.example .env
    
    echo "Generating app key"
    php artisan key:generate
fi


#
# Permissions
#
if [ $server == 'production' ]; then
    dump "Setting permissions"
    chown -R ${productionUser} "${productionDocRoot}/core/storage"
    chown -R ${productionUser} "${productionDocRoot}/core/bootstrap/cache"
    chown -R ${productionUser} "${productionDocRoot}/core/database/migrations/"
    chown -R ${productionUser} "${productionDocRoot}/core/database/factories/GeneratedModels"
    chown -R ${productionUser} "${productionDocRoot}/core/app/Models/GeneratedModels/"
    chown -R ${productionUser} "${productionDocRoot}/core/app/Http/Controllers/GeneratedControllers/"
    chown -R ${productionUser} "${productionDocRoot}/core/app/Http/Requests/GeneratedRequests/"
    chown -R ${productionUser} "${productionDocRoot}/core/database/factories/GeneratedModels"
    chown -R ${productionUser} "${productionDocRoot}/core/routes"
fi


if [ $server == 'production' ]; then
    url="e28-api.yourdomain.com"
else
    url="e28-api.loc"
fi

dump "Expected Virtual Host:"
echo "
<VirtualHost *:80>
    ServerName $url
    DocumentRoot $publicDir
    <Directory $publicDir>
        AllowOverride All
        Options -Indexes
        Require all granted
    </Directory>
</VirtualHost>
"


#
# Build API
#
dump "Build API"

$phpExecutable artisan e28-api:setup